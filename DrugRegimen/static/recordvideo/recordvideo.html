<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Account</title>
  <link rel="shortcut icon" type="image/png" href="/static/admin/img/favicon.png" />
  {% load static %}
  <link rel="stylesheet" href="{% static 'admin/css/navbaretc.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/pagecontent.css' %}">
  <style>
    .bottom {
      clear: both;
      padding-top: 10px;
    }

    .button-container {
      margin-left: 250px;
      margin-right: 250px;
    }

    .buttons {
      display: flex;
      justify-content: center;
    }

    .buttonrec {
      background-color: #006857;
      margin: 10px;
      padding-top: 10px;
      padding-bottom: 7px;
      text-align: center;
      border: black solid 2px;
      border-radius: 10px;
      width: 100px;
      flex-grow: 1;
    }

    .dot {
      height: 25px;
      width: 25px;
      background-color: rgb(211, 0, 0);
      border-radius: 50%;
      display: inline-block;
    }

    .square {
      height: 23px;
      width: 23px;
      background-color: blue;
      display: inline-block;
    }

    .videos {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    #preview {
      border: #006857 solid 10px;
      border-radius: 10px;
    }

    #recording {
      border: #006857 solid 10px;
      border-radius: 10px;
    }

    video {
      margin: 20px;
    }

    #downloadButton {
      color: white;
      font-size: larger;
    }

    #message {
      border: black solid 2px;
      background-color: #006857;
      text-align: center;
      display: flex;
      justify-content: center;
      align-content: center;
      flex-direction: column;
      margin-left: 260px;
      margin-right: 260px;
      border-radius: 10px;
    }

    #message p {
      color: white;
      font-size: xx-large;
    }

    .imgbrand img {
      margin-left: 50px
    }

    @media(max-width: 500px) {
      .bottom {
        clear: both;
        padding-top: 10px;
      }

      .button-container {
        margin-left: 0px;
        margin-right: 0px;
      }

      .buttons {
        display: flex;
        justify-content: center;
      }

      .buttonrec {
        background-color: #006857;
        margin: 0px;
        margin-top: 5px;
        padding-top: 10px;
        padding-bottom: 7px;
        text-align: center;
        border: black solid 2px;
        border-radius: 10px;
        width: 100px;
        flex-grow: 1;
      }

      #stopButton {
        margin-left: 5px;
        margin-right: 5px;
      }

      .dot {
        height: 22px;
        width: 22px;
        background-color: rgb(211, 0, 0);
        border-radius: 50%;
        display: inline-block;
      }

      .square {
        height: 21px;
        width: 21px;
        background-color: blue;
        display: inline-block;
      }

      .videos {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
      }

      #preview {
        border: #000000 solid 5px;
        border-radius: 10px;
        width: 100vh;
        height: auto;
        margin-top: 5px;
      }

      #recording {
        border: #000000 solid 5px;
        border-radius: 10px;
        width: 100vh;
        height: auto;
        margin-top: 5px;
      }

      video {
        margin: 0px;
      }

      #message {
        border: black solid 2px;
        background-color: #006857;
        text-align: center;
        display: flex;
        justify-content: center;
        align-content: center;
        flex-direction: column;
        margin-left: 0px;
        margin-right: 0px;
        border-radius: 10px;
        margin-top: 5px;
      }

      #message p {
        color: white;
        font-size: large;
        padding: 0px;
        margin-block-start: 0.3em;
        margin-block-end: 0.3em;
      }

      #subnav {
        display: none;
      }

      .imgbrand img {
        display: block;
        margin: auto;
        width: 33%;
        height: 33%;
      }

      #pagecontent {
        margin-left: 0.75%;
      }
      #button-vid-container{
        display: flex;
        flex-direction: column-reverse;
      }
      #page-container{
        min-height: 0vh;
      }
    }
  </style>
</head>

<body>
  <div id="page-container">
    <header>
      <div class="imgbrand"><img width="8%" height="8%" src="{% static 'admin/img/regx.png' %}"></div>
      <nav class="navbar">
        <a href='http://127.0.0.1:8000/home' class="left-nav">Home</a>
        <a href='http://127.0.0.1:8000/about' class="left-nav">About</a>
        <a href='http://127.0.0.1:8000/drug-interactions' id="inter" class="left-nav">Drug Interactions</a>
        <a href='http://127.0.0.1:8000/help' class="left-nav">Help</a>
        <div class="dropdown">
          <a href='#' class="dropbtn">{{ username }}</a>
          <div class="dropdown-content">
            <a href="http://127.0.0.1:8000/account">Account</a>
            <a href="http://127.0.0.1:8000">Sign Out</a>
          </div>
        </div>
      </nav>
    </header>
    <main>
      <div id="pagecontent">
        <div id="subnav">
          <h3>Record Video</h2>
        </div>
        <div id="message">
          <p>Click the "<span class="dot"></span>" button to begin video recording for a few seconds</p>
          <br>
        </div>

        <div id="button-vid-container">
          <div class="button-container">
            <div class="buttons">
              <div id="startButton" class="buttonrec">
                <span class="dot"></span>
              </div>
              <div id="stopButton" class="buttonrec">
                <span class="square"></span>
              </div>
              <a id="downloadButton" class="buttonrec">
                Upload
              </a>
            </div>
          </div>

          <div class="videos">
            <video id="preview" width="640" height="480" autoplay muted></video>

            <video id="recording" width="640" height="480" controls></video>
          </div>
        </div>
        <div class="bottom">
          <pre id="log"></pre>
        </div>


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

        <script>
          let preview = document.getElementById("preview");
          let recording = document.getElementById("recording");
          let startButton = document.getElementById("startButton");
          let stopButton = document.getElementById("stopButton");
          let downloadButton = document.getElementById("downloadButton");
          let logElement = document.getElementById("log");

          let recordingTimeMS = 5000;

          function log(msg) {
            logElement.innerHTML += msg + "\n";
          }

          function wait(delayInMS) {
            return new Promise(resolve => setTimeout(resolve, delayInMS));
          }

          function startRecording(stream, lengthInMS) {
            let recorder = new MediaRecorder(stream);
            let data = [];

            recorder.ondataavailable = event => data.push(event.data);
            recorder.start();
            log(recorder.state + " for " + (lengthInMS / 1000) + " seconds...");

            let stopped = new Promise((resolve, reject) => {
              recorder.onstop = resolve;
              recorder.onerror = event => reject(event.name);
            });

            let recorded = wait(lengthInMS).then(
              () => recorder.state == "recording" && recorder.stop()
            );

            return Promise.all([
              stopped,
              recorded
            ])
              .then(() => data);
          }

          function stop(stream) {
            stream.getTracks().forEach(track => track.stop());
          }


          startButton.addEventListener("click", function () {
            navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            }).then(stream => {
              preview.srcObject = stream;
              downloadButton.href = stream;
              preview.captureStream = preview.captureStream || preview.mozCaptureStream;
              return new Promise(resolve => preview.onplaying = resolve);
            }).then(() => startRecording(preview.captureStream(), recordingTimeMS))
              .then(recordedChunks => {
                let recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
                recording.src = URL.createObjectURL(recordedBlob);
                downloadButton.href = recording.src;
                var formData = new FormData();
                formData.append('video', recordedBlob);
                formData.append('doseURL', "{{ doseURL }}")
                formData.append('date', "{{ date }}")
                $.ajax({
                  type: 'POST',
                  url: '/upload',
                  data: formData,
                  processData: false,
                  contentType: false
                }).done(function (data) {
                  console.log(data);
                });
                log("Successfully recorded " + recordedBlob.size + " bytes of " +
                  recordedBlob.type + " media.");
              })
              .catch(log);
          }, false);
          stopButton.addEventListener("click", function () {
            stop(preview.srcObject);
          }, false);
        </script>
      </div>
    </main>
    <footer class="footer">
      <div class="imgbrand"><img src="{% static 'admin/img/synergy.png' %}"></div>
      <div class="text">Copyright &copy; Team 5 2021</div>
    </footer>
  </div>
</body>

</html>